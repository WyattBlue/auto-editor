'''scripts/premiere.py'''

"""
This script's purpose is to export an XML file that can be imported by Adobe Premiere.

It doesn't support zooming in yet.
"""

# External libraries
import cv2

# Included functions
from scripts.usefulFunctions import getAudioChunks
from scripts.wavfile import read, write

# Internal libraries
import os
import tempfile
import subprocess
from shutil import rmtree
from datetime import timedelta

def exportToPremiere(myInput, newOutput, silentT, zoomT, frameMargin, sampleRate,
    videoSpeed, silentSpeed):
    print('Running from premiere.py')
    TEMP = tempfile.mkdtemp()

    cap = cv2.VideoCapture(myInput)
    fps = round(cap.get(cv2.CAP_PROP_FPS))

    cmd = ['ffmpeg', '-i', myInput, '-ab', '160k', '-ac', '2', '-ar',
        str(sampleRate), '-vn', f'{TEMP}/output.wav', '-nostats', '-loglevel', '0']
    subprocess.call(cmd)

    sampleRate, audioData = read(f'{TEMP}/output.wav')
    chunks = getAudioChunks(audioData, sampleRate, fps, silentT, zoomT, frameMargin)

    rmtree(TEMP)

    print('\nWarning, this code is very underdeveloped and does not support many features.')

    print('\nDev Info\n========')

    print(chunks)
    pathurl = 'file://localhost' + os.path.abspath(myInput)
    print('pathurl:', pathurl)
    name = os.path.basename(myInput)
    print('video name:', name)

    ntsc = 'TRUE'
    ana = 'FALSE' # anamorphic
    alphatype = 'none'
    depth = '16'
    width = '1280'
    height = '720'
    pixelar = 'square' # pixel aspect ratio
    colordepth = '24'
    sr = sampleRate


    with open('export.xml', 'w', encoding='utf-8') as outfile:
        outfile.write('<!-- Generated by Auto-Editor -->\n')
        outfile.write('<!-- https://github.com/WyattBlue/auto-editor -->\n')
        outfile.write('\n')
        outfile.write('<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE xmeml>\n')
        outfile.write('<xmeml version="4">\n')
        outfile.write('\t<sequence>\n')
        outfile.write('\t\t<name>auto-editor export group</name>\n')
        outfile.write('\t\t<media>\n')
        outfile.write('\t\t\t<video>\n')
        outfile.write('\t\t\t\t<format>\n')
        outfile.write('\t\t\t\t\t<samplecharacteristics>\n')
        outfile.write('\t\t\t\t\t\t<rate>\n')
        outfile.write('\t\t\t\t\t\t\t<timebase>30</timebase>\n')
        outfile.write(f'\t\t\t\t\t\t\t<ntsc>{ntsc}</ntsc>\n')
        outfile.write('\t\t\t\t\t\t</rate>\n')
        outfile.write(f'\t\t\t\t\t\t<width>{width}</width>\n')
        outfile.write(f'\t\t\t\t\t\t<height>{height}</height>\n')
        outfile.write(f'\t\t\t\t\t\t<anamorphic>{ana}</anamorphic>\n')
        outfile.write(f'\t\t\t\t\t\t<pixelaspectratio>{pixelar}</pixelaspectratio>\n')
        outfile.write('\t\t\t\t\t\t<fielddominance>none</fielddominance>\n')
        outfile.write(f'\t\t\t\t\t\t<colordepth>{colordepth}</colordepth>\n')
        outfile.write('\t\t\t\t\t</samplecharacteristics>\n')
        outfile.write('\t\t\t\t</format>\n')


    return 'export.xml'






